ðŸ“¦
52870 /dump.js
âœ„
var ne=(e,t)=>()=>(e&&(t=e(e=0)),t);var Oe=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var H=ne(()=>{});function Y(){if(oe!==null)return oe;let e={},t=[{module:"libsystem_malloc.dylib",functions:{free:["void",["pointer"]]}},{module:"libobjc.A.dylib",functions:{objc_msgSend:function(n){this.objc_msgSend=n},objc_msgSend_stret:function(n){this.objc_msgSend_stret=n},objc_msgSend_fpret:function(n){this.objc_msgSend_fpret=n},objc_msgSendSuper:function(n){this.objc_msgSendSuper=n},objc_msgSendSuper_stret:function(n){this.objc_msgSendSuper_stret=n},objc_msgSendSuper_fpret:function(n){this.objc_msgSendSuper_fpret=n},objc_getClassList:["int",["pointer","int"]],objc_lookUpClass:["pointer",["pointer"]],objc_allocateClassPair:["pointer",["pointer","pointer","pointer"]],objc_disposeClassPair:["void",["pointer"]],objc_registerClassPair:["void",["pointer"]],class_isMetaClass:["bool",["pointer"]],class_getName:["pointer",["pointer"]],class_getImageName:["pointer",["pointer"]],class_copyProtocolList:["pointer",["pointer","pointer"]],class_copyMethodList:["pointer",["pointer","pointer"]],class_getClassMethod:["pointer",["pointer","pointer"]],class_getInstanceMethod:["pointer",["pointer","pointer"]],class_getSuperclass:["pointer",["pointer"]],class_addProtocol:["bool",["pointer","pointer"]],class_addMethod:["bool",["pointer","pointer","pointer","pointer"]],class_copyIvarList:["pointer",["pointer","pointer"]],objc_getProtocol:["pointer",["pointer"]],objc_copyProtocolList:["pointer",["pointer"]],objc_allocateProtocol:["pointer",["pointer"]],objc_registerProtocol:["void",["pointer"]],protocol_getName:["pointer",["pointer"]],protocol_copyMethodDescriptionList:["pointer",["pointer","bool","bool","pointer"]],protocol_copyPropertyList:["pointer",["pointer","pointer"]],protocol_copyProtocolList:["pointer",["pointer","pointer"]],protocol_addProtocol:["void",["pointer","pointer"]],protocol_addMethodDescription:["void",["pointer","pointer","pointer","bool","bool"]],ivar_getName:["pointer",["pointer"]],ivar_getTypeEncoding:["pointer",["pointer"]],ivar_getOffset:["pointer",["pointer"]],object_isClass:["bool",["pointer"]],object_getClass:["pointer",["pointer"]],object_getClassName:["pointer",["pointer"]],method_getName:["pointer",["pointer"]],method_getTypeEncoding:["pointer",["pointer"]],method_getImplementation:["pointer",["pointer"]],method_setImplementation:["pointer",["pointer","pointer"]],property_getName:["pointer",["pointer"]],property_copyAttributeList:["pointer",["pointer","pointer"]],sel_getName:["pointer",["pointer"]],sel_registerName:["pointer",["pointer"]],class_getInstanceSize:["pointer",["pointer"]]},optionals:{objc_msgSend_stret:"ABI",objc_msgSend_fpret:"ABI",objc_msgSendSuper_stret:"ABI",objc_msgSendSuper_fpret:"ABI",object_isClass:"iOS8"}},{module:"libdispatch.dylib",functions:{dispatch_async_f:["void",["pointer","pointer","pointer"]]},variables:{_dispatch_main_q:function(n){this._dispatch_main_q=n}}}],r=0;return t.forEach(function(n){let s=n.module==="libobjc.A.dylib",l=n.functions||{},o=n.variables||{},u=n.optionals||{};r+=Object.keys(l).length+Object.keys(o).length;let a=(Process.findModuleByName(n.module)?.enumerateExports()??[]).reduce(function(i,c){return i[c.name]=c,i},{});Object.keys(l).forEach(function(i){let c=a[i];if(c!==void 0&&c.type==="function"){let d=l[i];typeof d=="function"?(d.call(e,c.address),s&&d.call(e,c.address)):(e[i]=new NativeFunction(c.address,d[0],d[1],J),s&&(e[i]=e[i])),r--}else u[i]&&r--}),Object.keys(o).forEach(function(i){let c=a[i];c!==void 0&&c.type==="variable"&&(o[i].call(e,c.address),r--)})}),r===0&&(e.objc_msgSend_stret||(e.objc_msgSend_stret=e.objc_msgSend),e.objc_msgSend_fpret||(e.objc_msgSend_fpret=e.objc_msgSend),e.objc_msgSendSuper_stret||(e.objc_msgSendSuper_stret=e.objc_msgSendSuper),e.objc_msgSendSuper_fpret||(e.objc_msgSendSuper_fpret=e.objc_msgSendSuper),oe=e),oe}var oe,J,de=ne(()=>{H();oe=null,J={exceptions:"propagate"}});function _e(){return pe===null&&(pe=je()),pe}function je(){let{objc_getClassList:e,class_getSuperclass:t,class_getInstanceSize:r}=Y(),n=Memory.alloc(4);n.writeU32(Module.getGlobalExportByName("mach_task_self_").readU32());let s=new CModule(ke,{objc_getClassList:e,class_getSuperclass:t,class_getInstanceSize:r,malloc_get_all_zones:Process.getModuleByName("/usr/lib/system/libsystem_malloc.dylib").getExportByName("malloc_get_all_zones"),selfTask:n}),l=new NativeFunction(s.choose,"pointer",["pointer","bool","pointer"]),o=new NativeFunction(s.destroy,"void",["pointer"]);return{handle:s,choose(u,a){let i=[],c=Memory.alloc(4),d=l(u,a?1:0,c);try{let g=c.readU32();for(let h=0;h!==g;h++)i.push(d.add(h*Pe).readPointer())}finally{o(d)}return i}}}var ke,Pe,pe,ye=ne(()=>{H();de();ke=`#include <glib.h>
#include <ptrauth.h>

#define KERN_SUCCESS 0
#define MALLOC_PTR_IN_USE_RANGE_TYPE 1
#if defined (HAVE_I386) && GLIB_SIZEOF_VOID_P == 8
# define OBJC_ISA_MASK 0x7ffffffffff8ULL
#elif defined (HAVE_ARM64)
# define OBJC_ISA_MASK 0xffffffff8ULL
#endif

typedef struct _ChooseContext ChooseContext;

typedef struct _malloc_zone_t malloc_zone_t;
typedef struct _malloc_introspection_t malloc_introspection_t;
typedef struct _vm_range_t vm_range_t;

typedef gpointer Class;
typedef int kern_return_t;
typedef guint mach_port_t;
typedef mach_port_t task_t;
typedef guintptr vm_offset_t;
typedef guintptr vm_size_t;
typedef vm_offset_t vm_address_t;

struct _ChooseContext
{
  GHashTable * classes;
  GArray * matches;
};

struct _malloc_zone_t
{
  void * reserved1;
  void * reserved2;
  size_t (* size) (struct _malloc_zone_t * zone, const void * ptr);
  void * (* malloc) (struct _malloc_zone_t * zone, size_t size);
  void * (* calloc) (struct _malloc_zone_t * zone, size_t num_items, size_t size);
  void * (* valloc) (struct _malloc_zone_t * zone, size_t size);
  void (* free) (struct _malloc_zone_t * zone, void * ptr);
  void * (* realloc) (struct _malloc_zone_t * zone, void * ptr, size_t size);
  void (* destroy) (struct _malloc_zone_t * zone);
  const char * zone_name;

  unsigned (* batch_malloc) (struct _malloc_zone_t * zone, size_t size, void ** results, unsigned num_requested);
  void (* batch_free) (struct _malloc_zone_t * zone, void ** to_be_freed, unsigned num_to_be_freed);

  malloc_introspection_t * introspect;
};

typedef kern_return_t (* memory_reader_t) (task_t remote_task, vm_address_t remote_address, vm_size_t size, void ** local_memory);
typedef void (* vm_range_recorder_t) (task_t task, void * user_data, unsigned type, vm_range_t * ranges, unsigned count);
typedef kern_return_t (* enumerator_func) (task_t task, void * user_data, unsigned type_mask, vm_address_t zone_address, memory_reader_t reader,
      vm_range_recorder_t recorder);

struct _malloc_introspection_t
{
  enumerator_func enumerator;
};

struct _vm_range_t
{
  vm_address_t address;
  vm_size_t size;
};

extern int objc_getClassList (Class * buffer, int buffer_count);
extern Class class_getSuperclass (Class cls);
extern size_t class_getInstanceSize (Class cls);
extern kern_return_t malloc_get_all_zones (task_t task, memory_reader_t reader, vm_address_t ** addresses, unsigned * count);

static void collect_subclasses (Class klass, GHashTable * result);
static void collect_matches_in_ranges (task_t task, void * user_data, unsigned type, vm_range_t * ranges, unsigned count);
static kern_return_t read_local_memory (task_t remote_task, vm_address_t remote_address, vm_size_t size, void ** local_memory);

extern mach_port_t selfTask;

gpointer *
choose (Class * klass,
        gboolean consider_subclasses,
        guint * count)
{
  ChooseContext ctx;
  GHashTable * classes;
  vm_address_t * malloc_zone_addresses;
  unsigned malloc_zone_count, i;

  classes = g_hash_table_new_full (NULL, NULL, NULL, NULL);
  ctx.classes = classes;
  ctx.matches = g_array_new (FALSE, FALSE, sizeof (gpointer));
  if (consider_subclasses)
    collect_subclasses (klass, classes);
  else
    g_hash_table_insert (classes, klass, GSIZE_TO_POINTER (class_getInstanceSize (klass)));

  malloc_zone_count = 0;
  malloc_get_all_zones (selfTask, read_local_memory, &malloc_zone_addresses, &malloc_zone_count);

  for (i = 0; i != malloc_zone_count; i++)
  {
    vm_address_t zone_address = malloc_zone_addresses[i];
    malloc_zone_t * zone = (malloc_zone_t *) zone_address;
    enumerator_func enumerator;

    if (zone != NULL && zone->introspect != NULL &&
        (enumerator = (ptrauth_strip (zone->introspect, ptrauth_key_asda))->enumerator) != NULL)
    {
      enumerator = ptrauth_sign_unauthenticated (
          ptrauth_strip (enumerator, ptrauth_key_asia),
          ptrauth_key_asia, 0);

      enumerator (selfTask, &ctx, MALLOC_PTR_IN_USE_RANGE_TYPE, zone_address, read_local_memory,
          collect_matches_in_ranges);
    }
  }

  g_hash_table_unref (classes);

  *count = ctx.matches->len;

  return (gpointer *) g_array_free (ctx.matches, FALSE);
}

void
destroy (gpointer mem)
{
  g_free (mem);
}

static void
collect_subclasses (Class klass,
                    GHashTable * result)
{
  Class * classes;
  int count, i;

  count = objc_getClassList (NULL, 0);
  classes = g_malloc (count * sizeof (gpointer));
  count = objc_getClassList (classes, count);

  for (i = 0; i != count; i++)
  {
    Class candidate = classes[i];
    Class c;

    c = candidate;
    do
    {
      if (c == klass)
      {
        g_hash_table_insert (result, candidate, GSIZE_TO_POINTER (class_getInstanceSize (candidate)));
        break;
      }

      c = class_getSuperclass (c);
    }
    while (c != NULL);
  }

  g_free (classes);
}

static void
collect_matches_in_ranges (task_t task,
                           void * user_data,
                           unsigned type,
                           vm_range_t * ranges,
                           unsigned count)
{
  ChooseContext * ctx = user_data;
  GHashTable * classes = ctx->classes;
  unsigned i;

  for (i = 0; i != count; i++)
  {
    const vm_range_t * range = &ranges[i];
    gconstpointer candidate = GSIZE_TO_POINTER (range->address);
    gconstpointer isa;
    guint instance_size;

    isa = *(gconstpointer *) candidate;
#ifdef OBJC_ISA_MASK
    isa = GSIZE_TO_POINTER (GPOINTER_TO_SIZE (isa) & OBJC_ISA_MASK);
#endif

    instance_size = GPOINTER_TO_UINT (g_hash_table_lookup (classes, isa));
    if (instance_size != 0 && range->size >= instance_size)
    {
      g_array_append_val (ctx->matches, candidate);
    }
  }
}

static kern_return_t
read_local_memory (task_t remote_task,
                   vm_address_t remote_address,
                   vm_size_t size,
                   void ** local_memory)
{
  *local_memory = (void *) remote_address;

  return KERN_SUCCESS;
}
`,{pointerSize:Pe}=Process,pe=null});function Ie(){let pointerSize=Process.pointerSize,api=null,apiError=null,realizedClasses=new Set,classRegistry=new ClassRegistry,protocolRegistry=new ProtocolRegistry,replacedMethods=new Map,scheduledWork=new Map,nextId=1,workCallback=null,NSAutoreleasePool=null,bindings=new Map,readObjectIsa=null,msgSendBySignatureId=new Map,msgSendSuperBySignatureId=new Map,cachedNSString=null,cachedNSStringCtor=null,cachedNSNumber=null,cachedNSNumberCtor=null,singularTypeById=null,modifiers=null;try{tryInitialize()}catch(e){}function tryInitialize(){if(api!==null)return!0;if(apiError!==null)throw apiError;try{api=Y()}catch(e){throw apiError=e,e}return api!==null}function dispose(){for(let[e,t]of replacedMethods.entries()){let r=ptr(e),[n,s]=t;api.method_getImplementation(r).equals(s)&&api.method_setImplementation(r,n)}replacedMethods.clear()}Script.bindWeak(this,dispose),Object.defineProperty(this,"available",{enumerable:!0,get(){return tryInitialize()}}),Object.defineProperty(this,"api",{enumerable:!0,get(){return Y()}}),Object.defineProperty(this,"classes",{enumerable:!0,value:classRegistry}),Object.defineProperty(this,"protocols",{enumerable:!0,value:protocolRegistry}),Object.defineProperty(this,"Object",{enumerable:!0,value:ObjCObject}),Object.defineProperty(this,"Protocol",{enumerable:!0,value:ObjCProtocol}),Object.defineProperty(this,"Block",{enumerable:!0,value:Block}),Object.defineProperty(this,"mainQueue",{enumerable:!0,get(){return api?._dispatch_main_q??null}}),Object.defineProperty(this,"registerProxy",{enumerable:!0,value:registerProxy}),Object.defineProperty(this,"registerClass",{enumerable:!0,value:registerClass}),Object.defineProperty(this,"registerProtocol",{enumerable:!0,value:registerProtocol}),Object.defineProperty(this,"bind",{enumerable:!0,value:bind}),Object.defineProperty(this,"unbind",{enumerable:!0,value:unbind}),Object.defineProperty(this,"getBoundData",{enumerable:!0,value:getBoundData}),Object.defineProperty(this,"enumerateLoadedClasses",{enumerable:!0,value:enumerateLoadedClasses}),Object.defineProperty(this,"enumerateLoadedClassesSync",{enumerable:!0,value:enumerateLoadedClassesSync}),Object.defineProperty(this,"choose",{enumerable:!0,value:choose}),Object.defineProperty(this,"chooseSync",{enumerable:!0,value(e){let t=[];return choose(e,{onMatch(r){t.push(r)},onComplete(){}}),t}}),this.schedule=function(e,t){let r=ptr(nextId++);scheduledWork.set(r.toString(),t),workCallback===null&&(workCallback=new NativeCallback(performScheduledWorkItem,"void",["pointer"])),Script.pin(),api.dispatch_async_f(e,r,workCallback)};function performScheduledWorkItem(e){let t=e.toString(),r=scheduledWork.get(t);scheduledWork.delete(t),NSAutoreleasePool===null&&(NSAutoreleasePool=classRegistry.NSAutoreleasePool);let n=NSAutoreleasePool.alloc().init(),s=null;try{r()}catch(l){s=l}n.release(),setImmediate(performScheduledWorkCleanup,s)}function performScheduledWorkCleanup(e){if(Script.unpin(),e!==null)throw e}this.implement=function(e,t){return new NativeCallback(t,e.returnType,e.argumentTypes)},this.selector=selector,this.selectorAsString=selectorAsString;function selector(e){return api.sel_registerName(Memory.allocUtf8String(e))}function selectorAsString(e){return api.sel_getName(e).readUtf8String()}let registryBuiltins=new Set(["prototype","constructor","hasOwnProperty","toJSON","toString","valueOf"]);function ClassRegistry(){let e={},t=0,r=new Proxy(this,{has(i,c){return n(c)},get(i,c,d){switch(c){case"prototype":return i.prototype;case"constructor":return i.constructor;case"hasOwnProperty":return n;case"toJSON":return o;case"toString":return u;case"valueOf":return a;default:let g=l(c);return g!==null?g:void 0}},set(i,c,d,g){return!1},ownKeys(i){if(api===null)return[];let c=api.objc_getClassList(NULL,0);if(c!==t){let d=Memory.alloc(c*pointerSize);c=api.objc_getClassList(d,c);for(let g=0;g!==c;g++){let h=d.add(g*pointerSize).readPointer(),_=api.class_getName(h).readUtf8String();e[_]=h}t=c}return Object.keys(e)},getOwnPropertyDescriptor(i,c){return{writable:!1,configurable:!0,enumerable:!0}}});function n(i){return registryBuiltins.has(i)?!0:l(i)!==null}function s(i){let c=l(i);if(c===null)throw new Error("Unable to find class '"+i+"'");return c}function l(i){let c=e[i];if(c===void 0){if(c=api.objc_lookUpClass(Memory.allocUtf8String(i)),c.isNull())return null;e[i]=c,t++}return new ObjCObject(c,void 0,!0)}function o(){return Object.keys(r).reduce(function(i,c){return i[c]=s(c).toJSON(),i},{})}function u(){return"ClassRegistry"}function a(){return"ClassRegistry"}return r}function ProtocolRegistry(){let e={},t=0,r=new Proxy(this,{has(a,i){return n(i)},get(a,i,c){switch(i){case"prototype":return a.prototype;case"constructor":return a.constructor;case"hasOwnProperty":return n;case"toJSON":return l;case"toString":return o;case"valueOf":return u;default:let d=s(i);return d!==null?d:void 0}},set(a,i,c,d){return!1},ownKeys(a){if(api===null)return[];let i=Memory.alloc(pointerSize),c=api.objc_copyProtocolList(i);try{let d=i.readUInt();if(d!==t){e={};for(let g=0;g!==d;g++){let h=c.add(g*pointerSize).readPointer(),_=api.protocol_getName(h).readUtf8String();e[_]=h}t=d}}finally{api.free(c)}return Object.keys(e)},getOwnPropertyDescriptor(a,i){return{writable:!1,configurable:!0,enumerable:!0}}});function n(a){return registryBuiltins.has(a)?!0:s(a)!==null}function s(a){let i=e[a];if(i===void 0){if(i=api.objc_getProtocol(Memory.allocUtf8String(a)),i.isNull())return null;e[a]=i,t++}return new ObjCProtocol(i)}function l(){return Object.keys(r).reduce(function(a,i){return a[i]={handle:e[i]},a},{})}function o(){return"ProtocolRegistry"}function u(){return"ProtocolRegistry"}return r}let objCObjectBuiltins=new Set(["prototype","constructor","handle","hasOwnProperty","toJSON","toString","valueOf","equals","$kind","$super","$superClass","$class","$className","$moduleName","$protocols","$methods","$ownMethods","$ivars"]);function ObjCObject(e,t,r,n){let s=null,l=null,o=null,u=null,a=null,i=null,c=null,d=null,g=null,h=null,_=null,y={},S=null,P=null,k=null;if(e=getHandle(e),r===void 0){let b=api.object_getClass(e),p=b.toString();realizedClasses.has(p)||(api.objc_lookUpClass(api.class_getName(b)),realizedClasses.add(p))}let M=new Proxy(this,{has(b,p){return D(p)},get(b,p,N){switch(p){case"handle":return e;case"prototype":return b.prototype;case"constructor":return b.constructor;case"hasOwnProperty":return D;case"toJSON":return le;case"toString":case"valueOf":let C=N.description;if(C!==void 0){let v=C.call(N);if(v!==null)return v.UTF8String.bind(v)}return function(){return N.$className};case"equals":return te;case"$kind":return l===null&&(T()?l=api.class_isMetaClass(e)?"meta-class":"class":l="instance"),l;case"$super":if(o===null){let v=api.class_getSuperclass(x());if(v.isNull())o=[null];else{let O=Memory.alloc(2*pointerSize);O.writePointer(e),O.add(pointerSize).writePointer(v),o=[new ObjCObject(e,void 0,r,O)]}}return o[0];case"$superClass":if(u===null){let v=api.class_getSuperclass(x());v.isNull()?u=[null]:u=[new ObjCObject(v)]}return u[0];case"$class":return a===null&&(a=new ObjCObject(api.object_getClass(e),void 0,!0)),a;case"$className":return i===null&&(n?i=api.class_getName(n.add(pointerSize).readPointer()).readUtf8String():T()?i=api.class_getName(e).readUtf8String():i=api.object_getClassName(e).readUtf8String()),i;case"$moduleName":return c===null&&(c=api.class_getImageName(x()).readUtf8String()),c;case"$protocols":if(d===null){d={};let v=Memory.alloc(pointerSize),O=api.class_copyProtocolList(x(),v);if(!O.isNull())try{let L=v.readUInt();for(let w=0;w!==L;w++){let A=O.add(w*pointerSize).readPointer(),B=new ObjCProtocol(A);d[B.name]=B}}finally{api.free(O)}}return d;case"$methods":if(S===null){let v=n?n.add(pointerSize).readPointer():x(),O=api.object_getClass(v),L=new Set,w=O;do{for(let A of collectMethodNames(w,"+ "))L.add(A);w=api.class_getSuperclass(w)}while(!w.isNull());w=v;do{for(let A of collectMethodNames(w,"- "))L.add(A);w=api.class_getSuperclass(w)}while(!w.isNull());S=Array.from(L)}return S;case"$ownMethods":if(P===null){let v=n?n.add(pointerSize).readPointer():x(),O=api.object_getClass(v),L=collectMethodNames(O,"+ "),w=collectMethodNames(v,"- ");P=L.concat(w)}return P;case"$ivars":return k===null&&(T()?k={}:k=new ObjCIvars(M,x())),k;default:if(typeof p=="symbol")return b[p];if(t){let v=G(p);if(v===null||!v.implemented)return}let j=ae(p);return j===null?void 0:j}},set(b,p,N,C){return!1},ownKeys(b){if(g===null)if(t){let p=[],N=V();Object.keys(N).forEach(function(C){C[0]!=="+"&&C[0]!=="-"&&N[C].implemented&&p.push(C)}),g=p}else{let p={},N={},C=api.object_getClass(e);do{let j=Memory.alloc(pointerSize),v=api.class_copyMethodList(C,j),O=T()?"+ ":"- ";try{let L=j.readUInt();for(let w=0;w!==L;w++){let A=v.add(w*pointerSize).readPointer(),B=api.method_getName(A),U=api.sel_getName(B).readUtf8String();if(N[U]!==void 0)continue;N[U]=U;let R=jsMethodName(U),me=2,re=R;for(;p[re]!==void 0;)me++,re=R+me;p[re]=!0;let ge=O+U;if(y[ge]===void 0){let he={sel:B,handle:A,wrapper:null};y[ge]=he,y[re]=he}}}finally{api.free(v)}C=api.class_getSuperclass(C)}while(!C.isNull());g=Object.keys(p)}return["handle"].concat(g)},getOwnPropertyDescriptor(b,p){return{writable:!1,configurable:!0,enumerable:!0}}});return t&&(_=T()?null:ae("- respondsToSelector:")),M;function D(b){if(objCObjectBuiltins.has(b))return!0;if(t){let p=G(b);return!!(p!==null&&p.implemented)}return $(b)!==null}function x(){return s===null&&(s=T()?e:api.object_getClass(e)),s}function T(){return r===void 0&&(api.object_isClass?r=!!api.object_isClass(e):r=!!api.class_isMetaClass(api.object_getClass(e))),r}function $(b){let p=y[b];if(p!==void 0)return p;let N=ee(b),C=N[2];if(p=y[C],p!==void 0)return y[b]=p,p;let j=N[0],v=N[1],O=selector(v),L=T()?"+":"-";if(t){let w=G(C);w!==null&&(p={sel:O,types:w.types,wrapper:null,kind:j})}if(p===void 0){let w=j==="+"?api.class_getClassMethod(x(),O):api.class_getInstanceMethod(x(),O);if(!w.isNull())p={sel:O,handle:w,wrapper:null,kind:j};else{if(T()||j!=="-"||v==="forwardingTargetForSelector:"||v==="methodSignatureForSelector:")return null;let A=M;if("- forwardingTargetForSelector:"in M){let R=M.forwardingTargetForSelector_(O);if(R!==null&&R.$kind==="instance")A=R;else return null}else return null;let B=api.class_getInstanceMethod(api.object_getClass(A.handle),O);if(B.isNull())return null;let U=api.method_getTypeEncoding(B).readUtf8String();if((U===null||U==="")&&(U=I(A,C),U===null&&(U=I(M,C)),U===null))return null;p={sel:O,types:U,wrapper:null,kind:j}}}return y[C]=p,y[b]=p,j===L&&(y[jsMethodName(v)]=p),p}function I(b,p){let C=Object.keys(b.$protocols).map(j=>q({},b.$protocols[j])).reduce((j,v)=>(Object.assign(j,v),j),{})[p];return C===void 0?null:C.types}function q(b,p){return p.methods!==void 0&&Object.assign(b,p.methods),p.protocol!==void 0&&q(b,p.protocol),b}function G(b){let N=V()[b];return N!==void 0?N:null}function V(){if(h===null){let b={},p=collectProtocols(t),N=T()?"+":"-";Object.keys(p).forEach(function(C){let v=p[C].methods;Object.keys(v).forEach(function(O){let L=v[O],w=O.substr(2),A=O[0],B=!1,U=!1,R={types:L.types};Object.defineProperty(R,"implemented",{get(){return B||(L.required?U=!0:U=_!==null&&_.call(M,selector(w)),B=!0),U}}),b[O]=R,A===N&&(b[jsMethodName(w)]=R)})}),h=b}return h}function ae(b){let p=$(b);if(p===null)return null;let N=p.wrapper;return N===null&&(N=makeMethodInvocationWrapper(p,M,n,J),p.wrapper=N),N}function ee(b){let p=/([+\-])\s(\S+)/.exec(b),N,C;p===null?(C=T()?"+":"-",N=objcMethodName(b)):(C=p[1],N=p[2]);let j=[C,N].join(" ");return[C,N,j]}function le(){return{handle:e.toString()}}function te(b){return e.equals(getHandle(b))}}function getReplacementMethodImplementation(e){let t=replacedMethods.get(e.toString());if(t===void 0)return null;let[,r]=t;return r}function replaceMethodImplementation(e,t){let r=e.toString(),n,s=replacedMethods.get(r);s!==void 0?[n]=s:n=api.method_getImplementation(e),t.equals(n)?replacedMethods.delete(r):replacedMethods.set(r,[n,t]),api.method_setImplementation(e,t)}function collectMethodNames(e,t){let r=[],n=Memory.alloc(pointerSize),s=api.class_copyMethodList(e,n);try{let l=n.readUInt();for(let o=0;o!==l;o++){let u=s.add(o*pointerSize).readPointer(),a=api.method_getName(u),i=api.sel_getName(a).readUtf8String();r.push(t+i)}}finally{api.free(s)}return r}function ObjCProtocol(e){let t=null,r=null,n=null,s=null;Object.defineProperty(this,"handle",{value:e,enumerable:!0}),Object.defineProperty(this,"name",{get(){return t===null&&(t=api.protocol_getName(e).readUtf8String()),t},enumerable:!0}),Object.defineProperty(this,"protocols",{get(){if(r===null){r={};let o=Memory.alloc(pointerSize),u=api.protocol_copyProtocolList(e,o);if(!u.isNull())try{let a=o.readUInt();for(let i=0;i!==a;i++){let c=u.add(i*pointerSize).readPointer(),d=new ObjCProtocol(c);r[d.name]=d}}finally{api.free(u)}}return r},enumerable:!0}),Object.defineProperty(this,"properties",{get(){if(n===null){n={};let o=Memory.alloc(pointerSize),u=api.protocol_copyPropertyList(e,o);if(!u.isNull())try{let a=o.readUInt();for(let i=0;i!==a;i++){let c=u.add(i*pointerSize).readPointer(),d=api.property_getName(c).readUtf8String(),g={},h=api.property_copyAttributeList(c,o);if(!h.isNull())try{let _=o.readUInt();for(let y=0;y!==_;y++){let S=h.add(y*(2*pointerSize)),P=S.readPointer().readUtf8String(),k=S.add(pointerSize).readPointer().readUtf8String();g[P]=k}}finally{api.free(h)}n[d]=g}}finally{api.free(u)}}return n},enumerable:!0}),Object.defineProperty(this,"methods",{get(){if(s===null){s={};let o=Memory.alloc(pointerSize);l(s,o,{required:!0,instance:!1}),l(s,o,{required:!1,instance:!1}),l(s,o,{required:!0,instance:!0}),l(s,o,{required:!1,instance:!0})}return s},enumerable:!0});function l(o,u,a){let i=api.protocol_copyMethodDescriptionList(e,a.required?1:0,a.instance?1:0,u);if(!i.isNull())try{let c=u.readUInt();for(let d=0;d!==c;d++){let g=i.add(d*(2*pointerSize)),h=(a.instance?"- ":"+ ")+selectorAsString(g.readPointer()),_=g.add(pointerSize).readPointer().readUtf8String();o[h]={required:a.required,types:_}}}finally{api.free(i)}}}let objCIvarsBuiltins=new Set(["prototype","constructor","hasOwnProperty","toJSON","toString","valueOf"]);function ObjCIvars(e,t){let r={},n=null,s=[],l=t;do s.unshift(l),l=api.class_getSuperclass(l);while(!l.isNull());let o=Memory.alloc(pointerSize);s.forEach(h=>{let _=api.class_copyIvarList(h,o);try{let y=o.readUInt();for(let S=0;S!==y;S++){let P=_.add(S*pointerSize).readPointer(),k=api.ivar_getName(P).readUtf8String();r[k]=[P,null]}}finally{api.free(_)}});let u=new Proxy(this,{has(h,_){return i(_)},get(h,_,y){switch(_){case"prototype":return h.prototype;case"constructor":return h.constructor;case"hasOwnProperty":return i;case"toJSON":return c;case"toString":return d;case"valueOf":return g;default:let S=a(_);return S===null?void 0:S.get()}},set(h,_,y,S){let P=a(_);if(P===null)throw new Error("Unknown ivar");return P.set(y),!0},ownKeys(h){return n===null&&(n=Object.keys(r)),n},getOwnPropertyDescriptor(h,_){return{writable:!0,configurable:!0,enumerable:!0}}});return u;function a(h){let _=r[h];if(_===void 0)return null;let y=_[1];if(y===null){let S=_[0],P=api.ivar_getOffset(S).toInt32(),k=e.handle.add(P),M=parseType(api.ivar_getTypeEncoding(S).readUtf8String()),D=M.fromNative||identityTransform,x=M.toNative||identityTransform,T,$;h==="isa"?(T=readObjectIsa,$=function(){throw new Error("Unable to set the isa instance variable")}):(T=M.read,$=M.write),y={get(){return D.call(e,T(k))},set(I){$(k,x.call(e,I))}},_[1]=y}return y}function i(h){return objCIvarsBuiltins.has(h)?!0:r.hasOwnProperty(h)}function c(){return Object.keys(u).reduce(function(h,_){return h[_]=u[_],h},{})}function d(){return"ObjCIvars"}function g(){return"ObjCIvars"}}let blockDescriptorAllocSize,blockDescriptorDeclaredSize,blockDescriptorOffsets,blockSize,blockOffsets;pointerSize===4?(blockDescriptorAllocSize=16,blockDescriptorDeclaredSize=20,blockDescriptorOffsets={reserved:0,size:4,rest:8},blockSize=20,blockOffsets={isa:0,flags:4,reserved:8,invoke:12,descriptor:16}):(blockDescriptorAllocSize=32,blockDescriptorDeclaredSize=32,blockDescriptorOffsets={reserved:0,size:8,rest:16},blockSize=32,blockOffsets={isa:0,flags:8,reserved:12,invoke:16,descriptor:24});let BLOCK_HAS_COPY_DISPOSE=1<<25,BLOCK_HAS_CTOR=1<<26,BLOCK_IS_GLOBAL=1<<28,BLOCK_HAS_STRET=1<<29,BLOCK_HAS_SIGNATURE=1<<30;function Block(e,t=J){if(this._options=t,e instanceof NativePointer){let r=e.add(blockOffsets.descriptor).readPointer();this.handle=e;let n=e.add(blockOffsets.flags).readU32();if((n&BLOCK_HAS_SIGNATURE)!==0){let s=(n&BLOCK_HAS_COPY_DISPOSE)!==0?2:0;this.types=r.add(blockDescriptorOffsets.rest+s*pointerSize).readPointer().readCString(),this._signature=parseSignature(this.types)}else this._signature=null}else{this.declare(e);let r=Memory.alloc(blockDescriptorAllocSize+blockSize),n=r.add(blockDescriptorAllocSize),s=Memory.allocUtf8String(this.types);r.add(blockDescriptorOffsets.reserved).writeULong(0),r.add(blockDescriptorOffsets.size).writeULong(blockDescriptorDeclaredSize),r.add(blockDescriptorOffsets.rest).writePointer(s),n.add(blockOffsets.isa).writePointer(classRegistry.__NSGlobalBlock__),n.add(blockOffsets.flags).writeU32(BLOCK_HAS_SIGNATURE|BLOCK_IS_GLOBAL),n.add(blockOffsets.reserved).writeU32(0),n.add(blockOffsets.descriptor).writePointer(r),this.handle=n,this._storage=[r,s],this.implementation=e.implementation}}Object.defineProperties(Block.prototype,{implementation:{enumerable:!0,get(){let e=this.handle.add(blockOffsets.invoke).readPointer().strip(),t=this._getSignature();return makeBlockInvocationWrapper(this,t,new NativeFunction(e.sign(),t.retType.type,t.argTypes.map(function(r){return r.type}),this._options))},set(e){let t=this._getSignature(),r=new NativeCallback(makeBlockImplementationWrapper(this,t,e),t.retType.type,t.argTypes.map(function(o){return o.type}));this._callback=r;let n=this.handle.add(blockOffsets.invoke),s=Memory.queryProtection(n),l=s.includes("w");l||Memory.protect(n,Process.pointerSize,"rw-"),n.writePointer(r.strip().sign("ia",n)),l||Memory.protect(n,Process.pointerSize,s)}},declare:{value(e){let t=e.types;t===void 0&&(t=unparseSignature(e.retType,["block"].concat(e.argTypes))),this.types=t,this._signature=parseSignature(t)}},_getSignature:{value(){let e=this._signature;if(e===null)throw new Error("block is missing signature; call declare()");return e}}});function collectProtocols(e,t){t=t||{},t[e.name]=e;let r=e.protocols;return Object.keys(r).forEach(function(n){collectProtocols(r[n],t)}),t}function registerProxy(e){let t=e.protocols||[],r=e.methods||{},n=e.events||{},s=new Set(Object.keys(r).filter(a=>/([+\-])\s(\S+)/.exec(a)!==null).map(a=>a.split(" ")[1])),l={"- dealloc":function(){let a=this.data.target;"- release"in a&&a.release(),unbind(this.self),this.super.dealloc();let i=this.data.events.dealloc;i!==void 0&&i.call(this)},"- respondsToSelector:":function(a){let i=selectorAsString(a);return s.has(i)?!0:this.data.target.respondsToSelector_(a)},"- forwardingTargetForSelector:":function(a){let i=this.data.events.forward;return i!==void 0&&i.call(this,selectorAsString(a)),this.data.target},"- methodSignatureForSelector:":function(a){return this.data.target.methodSignatureForSelector_(a)},"- forwardInvocation:":function(a){a.invokeWithTarget_(this.data.target)}};for(var o in r)if(r.hasOwnProperty(o)){if(l.hasOwnProperty(o))throw new Error("The '"+o+"' method is reserved");l[o]=r[o]}let u=registerClass({name:e.name,super:classRegistry.NSProxy,protocols:t,methods:l});return function(a,i){a=a instanceof NativePointer?new ObjCObject(a):a,i=i||{};let c=u.alloc().autorelease(),d=getBoundData(c);d.target="- retain"in a?a.retain():a,d.events=n;for(var g in i)if(i.hasOwnProperty(g)){if(d.hasOwnProperty(g))throw new Error("The '"+g+"' property is reserved");d[g]=i[g]}this.handle=c.handle}}function registerClass(e){let t=e.name;t===void 0&&(t=makeClassName());let r=e.super!==void 0?e.super:classRegistry.NSObject,n=e.protocols||[],s=e.methods||{},l=[],o=api.objc_allocateClassPair(r!==null?r.handle:NULL,Memory.allocUtf8String(t),ptr("0"));if(o.isNull())throw new Error("Unable to register already registered class '"+t+"'");let u=api.object_getClass(o);try{n.forEach(function(a){api.class_addProtocol(o,a.handle)}),Object.keys(s).forEach(function(a){let i=/([+\-])\s(\S+)/.exec(a);if(i===null)throw new Error("Invalid method name");let c=i[1],d=i[2],g,h=s[a];if(typeof h=="function"){let k=null;if(a in r)k=r[a].types;else for(let M of n){let D=M.methods[a];if(D!==void 0){k=D.types;break}}if(k===null)throw new Error("Unable to find '"+a+"' in super-class or any of its protocols");g={types:k,implementation:h}}else g=h;let _=c==="+"?u:o,y=g.types;y===void 0&&(y=unparseSignature(g.retType,[c==="+"?"class":"object","selector"].concat(g.argTypes)));let S=parseSignature(y),P=new NativeCallback(makeMethodImplementationWrapper(S,g.implementation),S.retType.type,S.argTypes.map(function(k){return k.type}));l.push(P),api.class_addMethod(_,selector(d),P,Memory.allocUtf8String(y))})}catch(a){throw api.objc_disposeClassPair(o),a}return api.objc_registerClassPair(o),o._methodCallbacks=l,Script.bindWeak(o,makeClassDestructor(ptr(o))),new ObjCObject(o)}function makeClassDestructor(e){return function(){api.objc_disposeClassPair(e)}}function registerProtocol(e){let t=e.name;t===void 0&&(t=makeProtocolName());let r=e.protocols||[],n=e.methods||{};r.forEach(function(o){if(!(o instanceof ObjCProtocol))throw new Error("Expected protocol")});let s=Object.keys(n).map(function(o){let u=n[o],a=/([+\-])\s(\S+)/.exec(o);if(a===null)throw new Error("Invalid method name");let i=a[1],c=a[2],d=u.types;return d===void 0&&(d=unparseSignature(u.retType,[i==="+"?"class":"object","selector"].concat(u.argTypes))),{kind:i,name:c,types:d,optional:u.optional}}),l=api.objc_allocateProtocol(Memory.allocUtf8String(t));if(l.isNull())throw new Error("Unable to register already registered protocol '"+t+"'");return r.forEach(function(o){api.protocol_addProtocol(l,o.handle)}),s.forEach(function(o){let u=o.optional?0:1,a=o.kind==="-"?1:0;api.protocol_addMethodDescription(l,selector(o.name),Memory.allocUtf8String(o.types),u,a)}),api.objc_registerProtocol(l),new ObjCProtocol(l)}function getHandle(e){if(e instanceof NativePointer)return e;if(typeof e=="object"&&e.hasOwnProperty("handle"))return e.handle;throw new Error("Expected NativePointer or ObjC.Object instance")}function bind(e,t){let r=getHandle(e),n=e instanceof ObjCObject?e:new ObjCObject(r);bindings.set(r.toString(),{self:n,super:n.$super,data:t})}function unbind(e){let t=getHandle(e);bindings.delete(t.toString())}function getBoundData(e){return getBinding(e).data}function getBinding(e){let t=getHandle(e),r=t.toString(),n=bindings.get(r);if(n===void 0){let s=e instanceof ObjCObject?e:new ObjCObject(t);n={self:s,super:s.$super,data:{}},bindings.set(r,n)}return n}function enumerateLoadedClasses(...e){let t=new ModuleMap,r=!1,n,s;e.length===1?n=e[0]:(n=e[1],s=e[0].ownedBy),s===void 0&&(s=t,r=!0);let l=api.class_getName,o=n.onMatch.bind(n),u=(pointerSize===8?8:11)*pointerSize,a=api.objc_getClassList(NULL,0),i=Memory.alloc(a*pointerSize);api.objc_getClassList(i,a);for(let c=0;c!==a;c++){let d=i.add(c*pointerSize).readPointer(),g=l(d),h=null,_=s.findPath(g);if(_===null&&(r||t.findPath(g)===null)&&(h=g.readCString(),h.indexOf(".")!==-1)){let P=d.add(u).readPointer();_=s.findPath(P)}_!==null&&(h===null&&(h=g.readUtf8String()),o(h,_))}n.onComplete()}function enumerateLoadedClassesSync(e={}){let t={};return enumerateLoadedClasses(e,{onMatch(r,n){let s=t[n];s===void 0&&(s=[],t[n]=s),s.push(r)},onComplete(){}}),t}function choose(e,t){let r=e,n=!0;if(!(e instanceof ObjCObject)&&typeof e=="object"&&(r=e.class,e.hasOwnProperty("subclasses")&&(n=e.subclasses)),!(r instanceof ObjCObject&&(r.$kind==="class"||r.$kind==="meta-class")))throw new Error("Expected an ObjC.Object for a class or meta-class");let s=_e().choose(r,n).map(l=>new ObjCObject(l));for(let l of s)if(t.onMatch(l)==="stop")break;t.onComplete()}function makeMethodInvocationWrapper(method,owner,superSpecifier,invocationOptions){let sel=method.sel,handle=method.handle,types;handle===void 0?(handle=null,types=method.types):types=api.method_getTypeEncoding(handle).readUtf8String();let signature=parseSignature(types),retType=signature.retType,argTypes=signature.argTypes.slice(2),objc_msgSend=superSpecifier?getMsgSendSuperImpl(signature,invocationOptions):getMsgSendImpl(signature,invocationOptions),argVariableNames=argTypes.map(function(e,t){return"a"+(t+1)}),callArgs=[superSpecifier?"superSpecifier":"this","sel"].concat(argTypes.map(function(e,t){return e.toNative?"argTypes["+t+"].toNative.call(this, "+argVariableNames[t]+")":argVariableNames[t]})),returnCaptureLeft,returnCaptureRight;retType.type==="void"?(returnCaptureLeft="",returnCaptureRight=""):retType.fromNative?(returnCaptureLeft="return retType.fromNative.call(this, ",returnCaptureRight=")"):(returnCaptureLeft="return ",returnCaptureRight="");let m=eval("var m = function ("+argVariableNames.join(", ")+") { "+returnCaptureLeft+"objc_msgSend("+callArgs.join(", ")+")"+returnCaptureRight+"; }; m;");Object.defineProperty(m,"handle",{enumerable:!0,get:getMethodHandle}),m.selector=sel,Object.defineProperty(m,"implementation",{enumerable:!0,get(){let e=getMethodHandle(),t=new NativeFunction(api.method_getImplementation(e),m.returnType,m.argumentTypes,invocationOptions),r=getReplacementMethodImplementation(e);return r!==null&&(t._callback=r),t},set(e){replaceMethodImplementation(getMethodHandle(),e)}}),m.returnType=retType.type,m.argumentTypes=signature.argTypes.map(e=>e.type),m.types=types,Object.defineProperty(m,"symbol",{enumerable:!0,get(){return`${method.kind}[${owner.$className} ${selectorAsString(sel)}]`}}),m.clone=function(e){return makeMethodInvocationWrapper(method,owner,superSpecifier,e)};function getMethodHandle(){if(handle===null){if(owner.$kind==="instance"){let e=owner;do if("- forwardingTargetForSelector:"in e){let t=e.forwardingTargetForSelector_(sel);if(t===null||t.$kind!=="instance")break;let r=api.class_getInstanceMethod(t.$class.handle,sel);r.isNull()?e=t:handle=r}else break;while(handle===null)}if(handle===null)throw new Error("Unable to find method handle of proxied function")}return handle}return m}function makeMethodImplementationWrapper(signature,implementation){let retType=signature.retType,argTypes=signature.argTypes,argVariableNames=argTypes.map(function(e,t){return t===0?"handle":t===1?"sel":"a"+(t-1)}),callArgs=argTypes.slice(2).map(function(e,t){let r=argVariableNames[2+t];return e.fromNative?"argTypes["+(2+t)+"].fromNative.call(self, "+r+")":r}),returnCaptureLeft,returnCaptureRight;retType.type==="void"?(returnCaptureLeft="",returnCaptureRight=""):retType.toNative?(returnCaptureLeft="return retType.toNative.call(self, ",returnCaptureRight=")"):(returnCaptureLeft="return ",returnCaptureRight="");let m=eval("var m = function ("+argVariableNames.join(", ")+") { var binding = getBinding(handle);var self = binding.self;"+returnCaptureLeft+"implementation.call(binding"+(callArgs.length>0?", ":"")+callArgs.join(", ")+")"+returnCaptureRight+"; }; m;");return m}function makeBlockInvocationWrapper(block,signature,implementation){let retType=signature.retType,argTypes=signature.argTypes.slice(1),argVariableNames=argTypes.map(function(e,t){return"a"+(t+1)}),callArgs=argTypes.map(function(e,t){return e.toNative?"argTypes["+t+"].toNative.call(this, "+argVariableNames[t]+")":argVariableNames[t]}),returnCaptureLeft,returnCaptureRight;retType.type==="void"?(returnCaptureLeft="",returnCaptureRight=""):retType.fromNative?(returnCaptureLeft="return retType.fromNative.call(this, ",returnCaptureRight=")"):(returnCaptureLeft="return ",returnCaptureRight="");let f=eval("var f = function ("+argVariableNames.join(", ")+") { "+returnCaptureLeft+"implementation(this"+(callArgs.length>0?", ":"")+callArgs.join(", ")+")"+returnCaptureRight+"; }; f;");return f.bind(block)}function makeBlockImplementationWrapper(block,signature,implementation){let retType=signature.retType,argTypes=signature.argTypes,argVariableNames=argTypes.map(function(e,t){return t===0?"handle":"a"+t}),callArgs=argTypes.slice(1).map(function(e,t){let r=argVariableNames[1+t];return e.fromNative?"argTypes["+(1+t)+"].fromNative.call(this, "+r+")":r}),returnCaptureLeft,returnCaptureRight;retType.type==="void"?(returnCaptureLeft="",returnCaptureRight=""):retType.toNative?(returnCaptureLeft="return retType.toNative.call(this, ",returnCaptureRight=")"):(returnCaptureLeft="return ",returnCaptureRight="");let f=eval("var f = function ("+argVariableNames.join(", ")+") { if (!this.handle.equals(handle))this.handle = handle;"+returnCaptureLeft+"implementation.call(block"+(callArgs.length>0?", ":"")+callArgs.join(", ")+")"+returnCaptureRight+"; }; f;");return f.bind(block)}function rawFridaType(e){return e==="object"?"pointer":e}function makeClassName(){for(let e=1;;e++){let t="FridaAnonymousClass"+e;if(!(t in classRegistry))return t}}function makeProtocolName(){for(let e=1;;e++){let t="FridaAnonymousProtocol"+e;if(!(t in protocolRegistry))return t}}function objcMethodName(e){return e.replace(/_/g,":")}function jsMethodName(e){let t=e.replace(/:/g,"_");return objCObjectBuiltins.has(t)&&(t+="2"),t}let isaMasks={x64:"0x7ffffffffff8",arm64:"0xffffffff8"},rawMask=isaMasks[Process.arch];if(rawMask!==void 0){let e=ptr(rawMask);readObjectIsa=function(t){return t.readPointer().and(e)}}else readObjectIsa=function(e){return e.readPointer()};function getMsgSendImpl(e,t){return resolveMsgSendImpl(msgSendBySignatureId,e,t,!1)}function getMsgSendSuperImpl(e,t){return resolveMsgSendImpl(msgSendSuperBySignatureId,e,t,!0)}function resolveMsgSendImpl(e,t,r,n){if(r!==J)return makeMsgSendImpl(t,r,n);let{id:s}=t,l=e.get(s);return l===void 0&&(l=makeMsgSendImpl(t,r,n),e.set(s,l)),l}function makeMsgSendImpl(e,t,r){let n=e.retType.type,s=e.argTypes.map(function(a){return a.type}),l=["objc_msgSend"];r&&l.push("Super"),n instanceof Array&&!typeFitsInRegisters(n)?l.push("_stret"):(n==="float"||n==="double")&&l.push("_fpret");let u=l.join("");return new NativeFunction(api[u],n,s,t)}function typeFitsInRegisters(e){return Process.arch!=="x64"?!1:sizeOfTypeOnX64(e)<=16}function sizeOfTypeOnX64(e){if(e instanceof Array)return e.reduce((t,r)=>t+sizeOfTypeOnX64(r),0);switch(e){case"bool":case"char":case"uchar":return 1;case"int16":case"uint16":return 2;case"int":case"int32":case"uint":case"uint32":case"float":return 4;default:return 8}}function unparseSignature(e,t){let r=typeIdFromAlias(e),n=t.map(typeIdFromAlias),s=n.map(u=>singularTypeById[u].size),l=s.reduce((u,a)=>u+a,0),o=0;return r+l+n.map((u,a)=>{let i=u+o;return o+=s[a],i}).join("")}function parseSignature(e){let t=[e,0];parseQualifiers(t);let r=readType(t);readNumber(t);let n=[],s=JSON.stringify(r.type);for(;dataAvailable(t);){parseQualifiers(t);let l=readType(t);readNumber(t),n.push(l),s+=JSON.stringify(l.type)}return{id:s,retType:r,argTypes:n}}function parseType(e){return readType([e,0])}function readType(e){let t=readChar(e);if(t==="@"){let n=peekChar(e);n==="?"?(t+=n,skipChar(e),peekChar(e)==="<"&&skipExtendedBlock(e)):n==='"'&&(skipChar(e),readUntil('"',e))}else if(t==="^"){let n=peekChar(e);n==="@"&&(t+=n,skipChar(e))}let r=singularTypeById[t];if(r!==void 0)return r;if(t==="["){let n=readNumber(e),s=readType(e);return skipChar(e),arrayType(n,s)}else if(t==="{"){if(!tokenExistsAhead("=","}",e))return readUntil("}",e),structType([]);readUntil("=",e);let n=[],s;for(;(s=peekChar(e))!=="}";)s==='"'&&(skipChar(e),readUntil('"',e)),n.push(readType(e));return skipChar(e),structType(n)}else if(t==="("){readUntil("=",e);let n=[];for(;peekChar(e)!==")";)n.push(readType(e));return skipChar(e),unionType(n)}else{if(t==="b")return readNumber(e),singularTypeById.i;if(t==="^")return readType(e),singularTypeById["?"];if(modifiers.has(t))return readType(e);throw new Error("Unable to handle type "+t)}}function skipExtendedBlock(e){let t;for(skipChar(e);(t=peekChar(e))!==">";)peekChar(e)==="<"?skipExtendedBlock(e):(skipChar(e),t==='"'&&readUntil('"',e));skipChar(e)}function readNumber(e){let t="";for(;dataAvailable(e);){let r=peekChar(e),n=r.charCodeAt(0);if(n>=48&&n<=57)t+=r,skipChar(e);else break}return parseInt(t)}function readUntil(e,t){let r=t[0],n=t[1],s=r.indexOf(e,n);if(s===-1)throw new Error("Expected token '"+e+"' not found");let l=r.substring(n,s);return t[1]=s+1,l}function readChar(e){return e[0][e[1]++]}function peekChar(e){return e[0][e[1]]}function tokenExistsAhead(e,t,r){let[n,s]=r,l=n.indexOf(e,s);if(l===-1)return!1;let o=n.indexOf(t,s);if(o===-1)throw new Error("Expected to find terminator: "+t);return l<o}function skipChar(e){e[1]++}function dataAvailable(e){return e[1]!==e[0].length}let qualifierById={r:"const",n:"in",N:"inout",o:"out",O:"bycopy",R:"byref",V:"oneway"};function parseQualifiers(e){let t=[];for(;;){let r=qualifierById[peekChar(e)];if(r===void 0)break;t.push(r),skipChar(e)}return t}let idByAlias={char:"c",int:"i",int16:"s",int32:"i",int64:"q",uchar:"C",uint:"I",uint16:"S",uint32:"I",uint64:"Q",float:"f",double:"d",bool:"B",void:"v",string:"*",object:"@",block:"@?",class:"#",selector:":",pointer:"^v"};function typeIdFromAlias(e){if(typeof e=="object"&&e!==null)return`@"${e.type}"`;let t=idByAlias[e];if(t===void 0)throw new Error("No known encoding for type "+e);return t}let fromNativeId=function(e){return e.isNull()?null:e.toString(16)===this.handle.toString(16)?this:new ObjCObject(e)},toNativeId=function(e){if(e===null)return NULL;let t=typeof e;return t==="string"?(cachedNSStringCtor===null&&(cachedNSString=classRegistry.NSString,cachedNSStringCtor=cachedNSString.stringWithUTF8String_),cachedNSStringCtor.call(cachedNSString,Memory.allocUtf8String(e))):t==="number"?(cachedNSNumberCtor===null&&(cachedNSNumber=classRegistry.NSNumber,cachedNSNumberCtor=cachedNSNumber.numberWithDouble_),cachedNSNumberCtor.call(cachedNSNumber,e)):e},fromNativeBlock=function(e){return e.isNull()?null:e.toString(16)===this.handle.toString(16)?this:new Block(e)},toNativeBlock=function(e){return e!==null?e:NULL},toNativeObjectArray=function(e){if(e instanceof Array){let t=e.length,r=Memory.alloc(t*pointerSize);for(let n=0;n!==t;n++)r.add(n*pointerSize).writePointer(toNativeId(e[n]));return r}return e};function arrayType(e,t){return{type:"pointer",read(r){let n=[],s=t.size;for(let l=0;l!==e;l++)n.push(t.read(r.add(l*s)));return n},write(r,n){let s=t.size;n.forEach((l,o)=>{t.write(r.add(o*s),l)})}}}function structType(e){let t,r;if(e.some(function(l){return!!l.fromNative})){let l=e.map(function(o){return o.fromNative?o.fromNative:identityTransform});t=function(o){return o.map(function(u,a){return l[a].call(this,u)})}}else t=identityTransform;if(e.some(function(l){return!!l.toNative})){let l=e.map(function(o){return o.toNative?o.toNative:identityTransform});r=function(o){return o.map(function(u,a){return l[a].call(this,u)})}}else r=identityTransform;let[n,s]=e.reduce(function(l,o){let[u,a]=l,{size:i}=o,c=align(u,i);return a.push(c),[c+i,a]},[0,[]]);return{type:e.map(l=>l.type),size:n,read(l){return e.map((o,u)=>o.read(l.add(s[u])))},write(l,o){o.forEach((u,a)=>{e[a].write(l.add(s[a]),u)})},fromNative:t,toNative:r}}function unionType(e){let t=e.reduce(function(s,l){return l.size>s.size?l:s},e[0]),r,n;if(t.fromNative){let s=t.fromNative;r=function(l){return s.call(this,l[0])}}else r=function(s){return s[0]};if(t.toNative){let s=t.toNative;n=function(l){return[s.call(this,l)]}}else n=function(s){return[s]};return{type:[t.type],size:t.size,read:t.read,write:t.write,fromNative:r,toNative:n}}let longBits=pointerSize==8&&Process.platform!=="windows"?64:32;modifiers=new Set(["j","A","r","n","N","o","O","R","V","+"]),singularTypeById={c:{type:"char",size:1,read:e=>e.readS8(),write:(e,t)=>{e.writeS8(t)},toNative(e){return typeof e=="boolean"?e?1:0:e}},i:{type:"int",size:4,read:e=>e.readInt(),write:(e,t)=>{e.writeInt(t)}},s:{type:"int16",size:2,read:e=>e.readS16(),write:(e,t)=>{e.writeS16(t)}},l:{type:"int32",size:4,read:e=>e.readS32(),write:(e,t)=>{e.writeS32(t)}},q:{type:"int64",size:8,read:e=>e.readS64(),write:(e,t)=>{e.writeS64(t)}},C:{type:"uchar",size:1,read:e=>e.readU8(),write:(e,t)=>{e.writeU8(t)}},I:{type:"uint",size:4,read:e=>e.readUInt(),write:(e,t)=>{e.writeUInt(t)}},S:{type:"uint16",size:2,read:e=>e.readU16(),write:(e,t)=>{e.writeU16(t)}},L:{type:"uint"+longBits,size:longBits/8,read:e=>e.readULong(),write:(e,t)=>{e.writeULong(t)}},Q:{type:"uint64",size:8,read:e=>e.readU64(),write:(e,t)=>{e.writeU64(t)}},f:{type:"float",size:4,read:e=>e.readFloat(),write:(e,t)=>{e.writeFloat(t)}},d:{type:"double",size:8,read:e=>e.readDouble(),write:(e,t)=>{e.writeDouble(t)}},B:{type:"bool",size:1,read:e=>e.readU8(),write:(e,t)=>{e.writeU8(t)},fromNative(e){return!!e},toNative(e){return e?1:0}},v:{type:"void",size:0},"*":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)},fromNative(e){return e.readUtf8String()}},"@":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)},fromNative:fromNativeId,toNative:toNativeId},"@?":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)},fromNative:fromNativeBlock,toNative:toNativeBlock},"^@":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)},toNative:toNativeObjectArray},"^v":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)}},"#":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)},fromNative:fromNativeId,toNative:toNativeId},":":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)}},"?":{type:"pointer",size:pointerSize,read:e=>e.readPointer(),write:(e,t)=>{e.writePointer(t)}}};function identityTransform(e){return e}function align(e,t){let r=e%t;return r===0?e:e+(t-r)}}var Me,Z,be=ne(()=>{H();de();ye();Me=new Ie,Z=Me});var Xe=Oe(()=>{H();be();function Te(e){for(;Process.getModuleByName(e)==null;)Thread.sleep(0);return Process.getModuleByName(e)}Te("Foundation");var Ue=0,Le=2,Ae=512,W=0;function ie(e){return Memory.allocUtf8String(e)}function E(e){return typeof e=="number"&&(e=ptr(e)),e.readU32()}function Ee(e,t){return typeof e=="number"&&(e=ptr(e)),e.writeU64(t)}function Se(e){return Memory.alloc(e)}function F(e,t,r,n){var s;if(s=Module.getGlobalExportByName(t),s===null)return console.log("cannot find "+t),null;if(e==="f"){var l=new NativeFunction(s,r,n);return typeof l>"u"?(console.log("parse error "+t),null):l}else if(e==="d"){var o=s.readPointer();return typeof o>"u"?(console.log("parse error "+t),null):o}}var xe=F("f","NSSearchPathForDirectoriesInDomains","pointer",["int","int","int"]),Be=F("f","open","int",["pointer","int","int"]),se=F("f","read","int",["int","pointer","int"]),Q=F("f","write","int",["int","pointer","int"]),K=F("f","lseek","int64",["int","int64","int"]),ve=F("f","close","int",["int"]),Re=F("f","remove","int",["pointer"]),De=F("f","access","int",["pointer","int"]),He=F("f","dlopen","pointer",["pointer","int"]);function Fe(){var e=9,t=1,r=xe(e,t,1);return Z.Object(r).objectAtIndex_(0).toString()}function Ne(e,t,r){return typeof e=="string"&&(e=ie(e)),Be(e,t,r)}var z=null;function fe(){z=new Array;for(let e of Process.enumerateModules())e.path.indexOf(".app")!=-1&&z.push(e);return z}var $e=3405691582,Ge=3199925962,qe=4277009102,We=3472551422,Ke=4277009103,Ve=3489328638,Je=33,Ye=44;function Ze(e,t){return Array(t-e.length+1).join("0")+e}function X(e){e=Ze(e.toString(16),8);for(var t="",r=0;r<e.length;r=r+2)t+=e.charAt(e.length-r-2),t+=e.charAt(e.length-r-1);return parseInt(t,16)}function Qe(e){z==null&&(z=fe());for(var t=null,r=0;r<z.length;r++)if(z[r].path.indexOf(e)!=-1){t=z[r];break}if(t==null){console.log("Cannot find module");return}var n=z[r].base,s=z[r].size,l=z[r].name,o=Fe()+"/"+l+".fid",u=z[r].path;De(ie(o),0)||Re(ie(o));var a=Ne(o,Ae|Le,0),i=Ne(u,Ue,0);if(a==-1||i==-1){console.log("Cannot open file"+o);return}var c=!1,d=0,g=E(n),h=E(n.add(4)),_=E(n.add(8));g==qe||g==We?(c=!1,d=28):(g==Ke||g==Ve)&&(c=!0,d=32);var y=4096,S=Se(y);se(i,S,y);var P=0,k=0;if(g=E(S),g==Ge||g==$e){for(var I=4,M=X(E(S.add(I))),r=0;r<M;r++){var D=X(E(S.add(I+4))),x=X(E(S.add(I+8)));if(h==D&&_==x){P=X(E(S.add(I+12))),k=X(E(S.add(I+16)));break}I+=20}if(P==0||k==0)return;K(a,0,W),K(i,P,W);for(var r=0;r<parseInt(k/y);r++)se(i,S,y),Q(a,S,y);k%y&&(se(i,S,k%y),Q(a,S,k%y))}else{var T=0;for(K(i,0,W),K(a,0,W);T=se(i,S,y);)Q(a,S,T)}for(var $=E(n.add(16)),I=d,q=-1,G=0,V=0,ae=[],r=0;r<$;r++){var ee=E(n.add(I)),le=E(n.add(I+4));(ee==Je||ee==Ye)&&(q=I+16,G=E(n.add(I+8)),V=E(n.add(I+12))),I+=le}if(q!=-1){var te=Se(8);Ee(te,0),K(a,q,W),Q(a,te,4),K(a,G,W),Q(a,n.add(G),V)}return ve(a),ve(i),o}function Ce(e){var t=Z.classes.NSFileManager.defaultManager(),r=Memory.alloc(Process.pointerSize);r.writePointer(NULL);for(var n=t.contentsOfDirectoryAtPath_error_(e,r),s=0,l=n.count();s<l;s++){var o=n.objectAtIndex_(s),u=e.stringByAppendingPathComponent_(o);if(o.hasSuffix_(".framework")){var a=Z.classes.NSBundle.bundleWithPath_(u);a.isLoaded()?console.log("[frida-ios-dump]: "+o+" has been loaded. "):a.load()?console.log("[frida-ios-dump]: Load "+o+" success. "):console.log("[frida-ios-dump]: Load "+o+" failed. ")}else{if(o.hasSuffix_(".bundle")||o.hasSuffix_(".momd")||o.hasSuffix_(".strings")||o.hasSuffix_(".appex")||o.hasSuffix_(".app")||o.hasSuffix_(".lproj")||o.hasSuffix_(".storyboardc"))continue;var i=Memory.alloc(Process.pointerSize);if(i.writePointer(NULL),t.fileExistsAtPath_isDirectory_(u,i),i.readPointer()==1)Ce(u);else if(o.hasSuffix_(".dylib")){for(var c=0,d=0;d<z.length;d++)if(z[d].path.indexOf(o)!=-1){c=1,console.log("[frida-ios-dump]: "+o+" has been dlopen.");break}c||(He(ie(u.UTF8String()),9)?console.log("[frida-ios-dump]: dlopen "+o+" success. "):console.log("[frida-ios-dump]: dlopen "+o+" failed. "))}}}}function we(e){z=fe();var t=Z.classes.NSBundle.mainBundle().bundlePath();Ce(t),z=fe();for(var r=0;r<z.length;r++){console.log("start dump "+z[r].path);var n=Qe(z[r].path);send({dump:n,path:z[r].path})}send({app:t.toString()}),send({done:"ok"}),recv(we)}recv(we)});export default Xe();
